<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Web Bluetooth API のテスト</title>
</head>

<body>
<button id="connect">接続</button>
<button id="disconnect">切断</button>
<input id="message" value="hello" />
<button id="send">送信</button>

<script src="//cdnjs.cloudflare.com/ajax/libs/d3/4.3.0/d3.min.js"></script>
<script>
// 情報元： https://shimz.me/blog/microbit/5456
var bluetoothDevice;
var characteristic;
//注意：1.ハイフンは必要なので省略しないこと
//     2.小文字で記述しないとうまくいかない場合があるので気をつけること
// Service UUID
var SERVICE_UUID        = 'a6ad91bd-376e-465f-8c6c-460fd3e15038';

// Characteristic UUID
var CHARACTERISTIC_UUID = '80d881a6-1ab3-47f0-8c75-2c31eac31f43';

//ボタンイベントリスナー
d3.select("#connect").on("click", connect);
d3.select("#disconnect").on("click", disconnect);
d3.select("#send").on("click", sendMessage);

//PSoCに接続する
function connect() {
  let options = {};
  // 全てのBLEデバイスをスキャン対象とする場合はtrue
  // フィルタリングしたい場合はfalse
  options.acceptAllDevices = true;
  // デバイス名、デバイス名のプレフィックス, ServiceのUUID　すべてを満たすではなく、各々に該当するデバイスをフィルタ・表示
  options.filters = [
    {services: [SERVICE_UUID]},
    {name: "SAKETAMU"},
    {namePrefix: "SAKETAMU"}
  ];
  // 接続するService '利用するServiceのUniform Type Identifierを予め指定する'
  //,
  //optionalServices: [SERVICE_UUID];
  
  // BLEデバイスをScan
  navigator.bluetooth.requestDevice(options)
  .then(device => {
    bluetoothDevice = device;
    console.log("device", device);
    //デバイスに接続
    return device.gatt.connect();
  })
  .then(server =>{
    console.log("server", server)
    // Service取得
    return server.getPrimaryService(SERVICE_UUID);
  })
  .then(service => {
    console.log("service", service)
    // Characteristic取得
    return service.getCharacteristic(CHARACTERISTIC_UUID)
  })
  .then(chara => {
    console.log("characteristic", chara)
    alert("BLE接続が完了しました。");
    characteristic = chara;
    // characteristicに対してRead/Write/Notificationsの処理を記述
    characteristic.readValue()
      .then(response => {
      // データがStringの場合
      //const decoder = new TextDecoder('utf-8')
      //const str = decoder.decode(response)
      //console.log(str)

      // データがnumberの場合
      const num = getUintN(response)
      console.log(num)
    })
    .catch(error => console.error(error))

    // 数値変換
    const getUintN = (dataView) => {
      switch(dataView.byteLength) {
        case 0:
          return 0
        case 1:
          return dataView.getUint8(0)
        case 2:
         return dataView.getUint16(0)
        case 4:
          return dataView.getUint32(0)
       case 8: {
         const top = dataView.getUint32(0) * Math.pow(2, 32)
          const bottom = dataView.getUint32(4)
          return top + bottom
        }
        default:
          return 0
      }
    }
  })
  .catch(error => {
    console.log(error);
  });
}

//ペリフェラルへメッセージを送信
function sendMessage() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected || !characteristic) return ;
  var text = document.querySelector("#message").value;
  var arrayBuffe = new TextEncoder().encode(text);
  characteristic.writeValue(arrayBuffe);
}

//BLE切断処理
function disconnect() {
  if (!bluetoothDevice || !bluetoothDevice.gatt.connected) return ;
  bluetoothDevice.gatt.disconnect();
  alert("BLE接続を切断しました。")
}
</script>
</body>
</html>
