<!doctype html>
<!--
Copyright 2021 Analog Devices, YaoyorozTech.Ltd
-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="Web Bluetooth API Prototype">
    <meta name="viewport" content="width=640, maximum-scale=1.0, user-scalable=yes">
    <title>SakeTamu</title>
    <link href="https://fonts.googleapis.com/css?family=Lato:100,300,400,700,900" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="style.css">
    <script type="text/javascript" src="bluejelly.js"></script>
    <script type="text/javascript" src="./smoothie.js"></script>
</head>

<body>
    <div class="container">

        <div class="title margin">
            <p id="title">Web Bluetooth API Sample</p>
            <p id="subtitle">Sensorデータの読み込み</p>
        </div>

        <div class="contents margin">
            <tr>
            <td><button id="connect" class="button">Connect</button></td>
            <td><button id="read" class="button">Read</button></td>
            <td><button id="reset" class="button">Reset</button></td>
            </tr>

            <hr>
            <canvas id="chart" width="500" height="320"></canvas>


            <div id="device_name">xxxx</div>
            <div id="uuid_name">xxxx</div>
            <div id="data_text">xxxx</div>
            <div id="status">xxxx</div>
            <div id="byteLength">xxxx</div>

        </div>

        <div class="footer margin">
          &copy; 2021 <a href="https://yaoyoroztech.com/" target="_blank">YaoyorozTech.Ltd</a>  All Rights Reserved
        </div>

    </div>

    <script>
        //--------------------------------------------------
        //Global変数
        //--------------------------------------------------
        //BlueJellyのインスタンス生成
        var ble = new BlueJelly();

        //TimeSeriesのインスタンス生成
        const ble_data = new TimeSeries();


        //-------------------------------------------------
        //smoothie.js
        //-------------------------------------------------
        function createTimeline() {
            const chart = new SmoothieChart({
                millisPerPixel: 600,
                grid: {
                    fillStyle: '#ff8319',
                    strokeStyle: '#ffffff',
                    millisPerLine: 800
                },
                //maxValue: 180,
                //minValue: -180
            });
            chart.addTimeSeries(ble_data, {
                strokeStyle: 'rgba(255, 255, 255, 1)',
                fillStyle: 'rgba(255, 255, 255, 0.2)',
                lineWidth: 4
            });
            chart.streamTo(document.getElementById("chart"), 500);
        }


        //--------------------------------------------------
        //ロード時の処理
        //--------------------------------------------------
        window.onload = function () {
        　//データ出力有効化
          ble.setUUID("UUID1", BlueJelly.SERVICE_UUID, BlueJelly.CHARACTERISTICS_CHAR_DATA);
          //ble.write('UUID1', [0x01]);
        
          //smoothie.js
          createTimeline();
        }
 
 
        //--------------------------------------------------
        //Scan後の処理
        //--------------------------------------------------
        ble.onScan = function (deviceName) {
          document.getElementById('device_name').innerHTML = deviceName;
          document.getElementById('status').innerHTML = "found device!";
        }
 
 
        //--------------------------------------------------
        //ConnectGATT後の処理
        //--------------------------------------------------
        ble.onConnectGATT = function (uuid) {
          console.log('> connected GATT!');
 
          document.getElementById('uuid_name').innerHTML = uuid;
          document.getElementById('status').innerHTML = "connected GATT!";
        }
 
        //--------------------------------------------------
        //Read後の処理：得られたデータの表示など行う
        //--------------------------------------------------
        ble.onRead = function (data, uuid){
          //フォーマットに従って値を取得
          value = data.getUint8(0) // 255.0; //8bitの場合のフォーマット
           
          //コンソールに値を表示
          console.log(value);

          valuelength = value.byteLength    //データの長さを取得
          console.log(valuelength);
 
          //HTMLにデータを表示
          document.getElementById('data_text').innerHTML = value;
          document.getElementById('uuid_name').innerHTML = uuid;
          document.getElementById('status').innerHTML = "read data"
          document.getElementById('byteLength').innerHTML = valuelength;

          //グラフへ反映
          ble_data.append(new Date().getTime(), value);

          //再びRead
          ble.read('SAKETAMU');
        }
 
        //--------------------------------------------------
        //Write後の処理
        //--------------------------------------------------
        ble.onWrite = function(uuid){
          document.getElementById('uuid_name').innerHTML = uuid;
          document.getElementById('status').innerHTML = "written data"
        }
 
        //--------------------------------------------------
        //Start Notify後の処理
        //--------------------------------------------------
        ble.onStartNotify = function(uuid){
          console.log('> Start Notify!');
 
          document.getElementById('uuid_name').innerHTML = uuid;
          document.getElementById('status').innerHTML = "started Notify";
        }
 
 
        //--------------------------------------------------
        //Stop Notify後の処理
        //--------------------------------------------------
        ble.onStopNotify = function(uuid){
          console.log('> Stop Notify!');
 
          document.getElementById('uuid_name').innerHTML = uuid;
          document.getElementById('status').innerHTML = "stopped Notify";
        }

        //-------------------------------------------------
        //ボタンが押された時のイベント登録
        //--------------------------------------------------
        document.getElementById('read').addEventListener('click', function() {
            ble.read('SAKETAMU');
        });

        document.getElementById('reset').addEventListener('click', function() {
            ble.reset(); //reset is disconnect & clear
        });


        //--------------------------------------------------
        //ロード時の処理
        //--------------------------------------------------
        window.onload = function() {
            //初期の文字列表示
            document.getElementById('device_name').innerHTML = "No Device";
            document.getElementById('data_text').innerHTML = "No Data"

            //UUIDの設定
            //ble.setUUID("SAKETAMU", "a6ad91bd-376e-465f-8c6c-460fd3e15038", "80d881a6-1ab3-47f0-8c75-2c31eac31f43");
        }

        //connect
        document.getElementById('connect').addEventListener('click', function() {
          //データ出力ON
          //ble.write('UUID1', [0x01]);
          //Sensorデータを出力
          ble.setUUID("SAKETAMU", BlueJelly.SERVICE_UUID, BlueJelly.CHARACTERISTICS_CHAR_DATA);
        });
 
        //notify
        document.getElementById('startNotifications').addEventListener('click', function() {
              ble.startNotify('SAKETAMU');
        });
 
        document.getElementById('stopNotifications').addEventListener('click', function() {
              ble.stopNotify('SAKETAMU');
        });

        //--------------------------------------------------
        //Reset後の処理
        //--------------------------------------------------
        ble.onReset = function() {
            //HTMLに表示
            document.getElementById('device_name').innerHTML = "No Device";
        }
        
    </script>
</body>

</html>
